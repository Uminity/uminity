<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq"
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="icon" type="image/png" href="/assets/images/favicon.png">
    <title>Uminity</title>
</head>

<body>

    <!-- navbar -->
    <div id="nav-placeholder" class="pb-5"></div>


	<!-- 게시글 작성 / 수정 폼 -->
	<div class="container mt-5">
        <div class="card mb-4">
            <div class="card-body">
                <h2 id="formTitle" class="card-title">게시글 작성</h2>
                <form id="postForm">
                    <div class="mb-3">
                        <label for="postTitle" class="form-label">제목</label>
                        <input type="text" class="form-control" id="postTitle" placeholder="제목을 입력하세요" required>
                    </div>
                    <div class="mb-3">
                        <label for="postContent" class="form-label">내용</label>
                        <textarea class="form-control" id="postContent" rows="8" placeholder="내용을 입력하세요" required></textarea>
                    </div>
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-primary" id="btnSubmit">등록</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- footer -->
    <footer class="bg-light text-center text-lg-start mt-5 border-top">
        <div class="container p-4">
            <p class="text-center mb-0 text-muted">
                © 2025 Uminity. All rights reserved.
            </p>
        </div>
    </footer>

	<script src="/assets/js/util.js"></script>
    <script>
    window.onload = function(){
    	loadNavbar();
    	
    	let postId = window.location.pathname.split("/").pop();
    	
    	// update 라면 postId 를 살려서 이를 토대로 post 내부 값을 가져옴
    	if(postId == "postForm"){ postId = null }
    	if(postId){
    		loadPost(postId);
    		document.querySelector("#formTitle").innerText = "게시글 수정";
    		document.querySelector("#btnSubmit").innerText = "수정";
    	}
    	
    	document.querySelector("#btnSubmit").onclick = async function(){
    		let title = document.querySelector("#postTitle").value.trim();
    		let content = document.querySelector("#postContent").value.trim();
    		let userJson = sessionStorage.getItem("user");
    		console.log(userJson);
    		if (!title || !content) {
    		    alert("제목과 내용을 모두 입력해주세요.");
    		    return;
    		}
    		
        	let postData = {title, content};
        	let response;
        	
        	if(postId){ // update
        		response = await fetch(`/api/posts/${postId}`, {
        			method: 'PUT',
        			headers: {
        				'Content-Type': 'application/json',
        			},
        			body: JSON.stringify(postData),
        		});
        	
        		
        	}else{ // create
        		response = await fetch(`/api/posts`, {
        			method: 'POST',
        			headers: {
        				'Content-Type': 'application/json',
        			},
        			body: JSON.stringify(postData),
        		});
        	}
        	// 게시글 작성 후 응답을 정상적으로 받았는지 확인
        	if(response.ok){
    			let result = await response.json();
    			window.location.href = `/postDetail/${result.postId}`;
    		}else{
    			alert("게시글 작성 중 오류가 발생하였습니다.");
    		}
    	}
    }
    
    async function loadPost(postId){
    	let response = await fetch(`/api/posts/${postId}`);
    	if(response.ok){
    		let post = await response.json();
        	console.log(post);
        	document.querySelector("#postTitle").value = post.title;
        	document.querySelector("#postContent").value = post.content;
        	
    	}else{
    		alert('게시글 수정 진행 중 오류가 발생하였습니다.');
    		console.error("HTTP Error:", response.status);
    	}
    	
    }
    </script>
</body>
</html>