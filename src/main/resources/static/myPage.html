<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Uminity - 마이페이지</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq"
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="icon" type="image/png" href="/assets/images/favicon.png">
    <!-- head 태그 내에 부트스트랩 아이콘 추가 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>
<body>

    <!-- navbar placeholder -->
    <div id="nav-placeholder"></div>

    <!-- 마이페이지 UI 개선 -->
    <div class="container my-5">
        <div class="row">
            <aside class="col-md-3 mb-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title mb-3">마이페이지</h5>
                        <div class="list-group list-group-flush" id="myTab" role="tablist">
                            <a class="list-group-item list-group-item-action active" id="info-tab" data-bs-toggle="list" href="#info" role="tab">
                                <i class="bi bi-person-gear me-2"></i> 회원정보 수정
                            </a>
                            <a class="list-group-item list-group-item-action" id="posts-tab" data-bs-toggle="list" href="#posts" role="tab">
                                <i class="bi bi-file-earmark-text me-2"></i> 내가 쓴 글
                            </a>
                            <a class="list-group-item list-group-item-action" id="comments-tab" data-bs-toggle="list" href="#comments" role="tab">
                                <i class="bi bi-chat-dots me-2"></i> 내가 쓴 댓글
                            </a>
                            <a class="list-group-item list-group-item-action text-danger" id="withdraw-tab" data-bs-toggle="list" href="#withdraw" role="tab">
                                <i class="bi bi-person-x me-2"></i> 회원 탈퇴
                            </a>
                        </div>
                    </div>
                </div>
            </aside>
            <main class="col-md-9">
                <div class="tab-content" id="myTabContent">
                    <div class="tab-pane fade show active" id="info" role="tabpanel" aria-labelledby="info-tab">
                        <!-- 회원정보 수정 폼 -->
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h2 class="card-title mb-4">
                                    <i class="bi bi-person-gear me-2"></i> 회원정보 수정
                                </h2>
                                <form id="updateForm">
                                    <div class="mb-3">
                                        <label for="name" class="form-label">이름</label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-light">
                                                <i class="bi bi-person"></i>
                                            </span>
                                            <input type="text" class="form-control" id="name" placeholder="이름 입력">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="email" class="form-label">이메일</label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-light">
                                                <i class="bi bi-envelope"></i>
                                            </span>
                                            <input type="email" class="form-control bg-light" id="email" placeholder="example@domain.com" readonly disabled>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="phone" class="form-label">휴대폰 번호</label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-light">
                                                <i class="bi bi-phone"></i>
                                            </span>
                                            <input type="tel" class="form-control" id="phone" placeholder="010-1234-5678">
                                        </div>
                                    </div>
                                    <div class="mb-4">
                                        <label for="role" class="form-label">등급</label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-light">
                                                <i class="bi bi-award"></i>
                                            </span>
                                            <input type="text" class="form-control bg-light" id="role" placeholder="일반유저" readonly disabled>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-check-lg me-1"></i> 저장하기
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="posts" role="tabpanel" aria-labelledby="comments-tab">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h2 class="card-title mb-4">
                                    <i class="bi bi-file-earmark-text me-2"></i> 내가 쓴 게시글
                                </h2>
                                <ul class="list-group" id="postList">
                                    <!-- JS가 여기를 채움 -->
                                </ul>
                                <nav class="mt-4">
                                    <ul class="pagination justify-content-center" id="paginationWrapper"></ul>
                                </nav>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="comments" role="tabpanel" aria-labelledby="comments-tab">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h2 class="card-title mb-4">
                                    <i class="bi bi-chat-dots me-2"></i> 내가 쓴 댓글
                                </h2>
                                <ul class="list-group" id="commentList">
                                    <!-- JS가 여기를 채움 -->
                                </ul>
                                <nav class="mt-4">
                                    <ul class="pagination justify-content-center" id="commentPagination"></ul>
                                </nav>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="reports" role="tabpanel" aria-labelledby="reports-tab" hidden>
                        <h2>신고 내역</h2>
                        <table class="table">
                            <thead>
                            <tr>
                                <th>대상</th>
                                <th>사유</th>
                                <th>날짜</th>
                                <th>상태</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td>게시글 제목 예시</td>
                                <td>스팸</td>
                                <td>2025-04-30</td>
                                <td>처리중</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="tab-pane fade" id="sanctions" role="tabpanel" aria-labelledby="sanctions-tab" hidden>
                        <h2>제재 내역</h2>
                        <ul class="list-group">
                            <li class="list-group-item">
                                <p>게시글 작성 제한<br><small class="text-muted">2025-05-05 ~ 2025-05-12</small></p>
                            </li>
                        </ul>
                    </div>

                    <div class="tab-pane fade" id="withdraw" role="tabpanel" aria-labelledby="withdraw-tab">
                        <div class="card shadow-sm border-danger">
                            <div class="card-body">
                                <h2 class="card-title text-danger mb-4">
                                    <i class="bi bi-exclamation-triangle me-2"></i> 회원 탈퇴
                                </h2>
                                <div class="alert alert-warning">
                                    <i class="bi bi-info-circle me-2"></i> 탈퇴 시 모든 데이터가 삭제되며 복구할 수 없습니다.
                                </div>
                                <p>탈퇴하시면 작성하신 게시글과 댓글은 남아있지만, 계정 정보는 삭제됩니다. 정말로 탈퇴하시겠습니까?</p>
                                <button type="button" class="btn btn-danger" id="btn-withdraw">
                                    <i class="bi bi-person-x me-2"></i> 탈퇴하기
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 공통 스크립트 (네비용 util.js 포함) -->
    <script src="/assets/js/util.js"></script>
    <script src="/assets/js/alert.js"></script>
    <script>
        window.onload = function () {
            // 1) 공통 네비 로드
            fetch('/assets/nav.html')
                .then(res => res.text())
                .then(html => {
                    document.getElementById('nav-placeholder').innerHTML = html;

                    // nav가 삽입된 뒤에만 initUI(), 로그아웃/마이페이지 이벤트 연결
                    initUI();
                    document.getElementById("linkLogout")
                        .addEventListener("click", logout);
                    document.getElementById("linkMyPage")
                        .addEventListener("click", function (e) {
                            e.preventDefault();
                            location.href = '/myPage';
                        });
                })
                .catch(err => console.error('네비 로드 실패:', err));
        };

        function initUI() {
            const userJson = sessionStorage.getItem("user");
            if (userJson) {
                const user = JSON.parse(userJson);
                document.querySelector("#navUser .nav-link").textContent = `${user.name}님`;
                showLoggedIn();
            } else showLoginOnly();
        }

        function showLoginOnly() {
            document.getElementById("navLogin").style.display = "";
            document.getElementById("navUser").style.display = "none";
            document.getElementById("navMyPage").style.display = "none";
            document.getElementById("navLogout").style.display = "none";
        }

        function showLoggedIn() {
            document.getElementById("navLogin").style.display = "none";
            document.getElementById("navUser").style.display = "";
            document.getElementById("navMyPage").style.display = "";
            document.getElementById("navLogout").style.display = "";
        }

        async function logout(e) {
            e.preventDefault();
            try {
                const res = await fetch("/logout", {method: "GET", credentials: "include"});
                if (!res.ok) console.warn("서버 로그아웃 실패:", res.status);
            } catch (err) {
                console.error("서버 로그아웃 에러:", err);
            }
            sessionStorage.removeItem("user");
            window.location.href = "/";
        }
    </script>

    <!-- 마이페이지 데이터 로드 & submit -->
    <script>
        async function loadMyInfo() {
            try {
                const res = await fetch('/api/v1/myPage', {
                    method: 'GET',
                    credentials: 'include'
                });
                if (!res.ok) throw res;
                const {name, email, phone, roles} = await res.json();
                document.getElementById('name').value = name;
                document.getElementById('email').value = email;
                document.getElementById('phone').value = phone;
                document.getElementById('role').value = roles.join(', ');
            } catch (err) {
                console.error('내 정보 로드 실패', err);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadMyInfo();

            const form = document.getElementById('updateForm');
            form.addEventListener('submit', async e => {
                e.preventDefault();

                const payload = {
                    name: document.getElementById('name').value.trim(),
                    phone: document.getElementById('phone').value.trim()
                };

                try {
                    const res = await fetch('/api/v1/myPage', {
                        method: 'PATCH',
                        credentials: 'include',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });

                    if (res.status === 204) {
                        showSuccessAlert('회원정보가 정상적으로 수정되었습니다.');
                        loadMyInfo();
                    } else {
                        const err = await res.json();
                        showErrorAlert('수정 실패 : ' + (err.message || res.status));
                    }
                } catch (err) {
                    console.error('수정 중 오류', err);
                    showErrorAlert('네트워크 오류가 발생했습니다.');
                }
            });

            document.getElementById('comments-tab')
                .addEventListener('shown.bs.tab', () => {
                    PAGE = 0;      // 필요하면 페이지 초기화
                    commentList();
                });

            document.getElementById('btn-withdraw')
                .addEventListener('click', withdrawUser);

            postList();
        });

        let SIZE = 10, PAGE = 0, SEARCH_TYPE = 'USERID', SEARCH_WORD = '';
        let TOTAL_POST_COUNT = 0, PAGE_LINK_COUNT = 5, CURRENT_PAGE_INDEX = 1;

        async function postList() {
            const userJson = sessionStorage.getItem("user");
            const user = userJson ? JSON.parse(userJson) : null;
            if (!user) {
                console.error("로그인 정보가 없습니다.");
                return;
            }

            const url = "/api/v1/myPage/posts"
                + "?page=" + PAGE
                + "&size=" + SIZE
                + "&searchType=" + SEARCH_TYPE
                + "&keyword=" + encodeURIComponent(user.userId);

            try {
                const res = await fetch(url, {credentials: 'include'});
                if (!res.ok) throw new Error(`게시글 조회 실패: ${res.status}`);
                const data = await res.json();

                const list = document.getElementById('postList');
                list.innerHTML = '';
                data.content.forEach(post => {
                    list.innerHTML += `
                        <li class="list-group-item">
                          <p><a href="/postDetail/${post.postId}">${post.title}</a></p>
                          <small class="text-muted">
                            <a>[조회수 : ${post.viewCnt}]</a>
                              ${formatDate(post.createdAt)}
                          </small>
                        </li>`;
                });

                makePaginationHTML(SIZE, data.totalPages, CURRENT_PAGE_INDEX,
                    data.totalElements, "paginationWrapper");
            } catch (err) {
                console.error(err);
            }
        }

        // 내가 쓴 댓글 로드
        async function commentList() {
            const userJson = sessionStorage.getItem("user");
            const user = userJson ? JSON.parse(userJson) : null;
            if (!user) {
                console.error("로그인 정보가 없습니다.");
                return;
            }

            const url = "/api/v1/myPage/comments"
                + "?userId=" + encodeURIComponent(user.userId)
                + "&page=" + PAGE
                + "&size=" + SIZE;

            try {
                const res = await fetch(url, {credentials: 'include'});
                if (!res.ok) throw new Error(`댓글 조회 실패: ${res.status}`);
                const data = await res.json();

                const list = document.getElementById('commentList');
                list.innerHTML = '';
                data.content.forEach(c => {
                    list.innerHTML += `
                        <li class="list-group-item">
                          <p>${c.content}</p>
                          <small class="text-muted">
                            <a href="/postDetail/${c.postId}"class="text-decoration-none">${c.postTitle}
                            </a>
                             — ${formatDate(c.createdAt)}
                          </small>
                        </li>`;
                });

                makePaginationHTML(SIZE, data.totalPages, CURRENT_PAGE_INDEX,
                    data.totalElements, "commentPagination");
            } catch (err) {
                console.error(err);
            }
        }

        async function withdrawUser() {
            const confirmed = await showConfirm('정말로 탈퇴하시겠습니까?', '회원 탈퇴', '탈퇴하기', '취소');
            if (!confirmed) return;
            try {
                const res = await fetch('/api/v1/myPage',
                    {method: 'DELETE', credentials: 'include'});
                console.log("탈퇴");
                if (res.ok) {
                    sessionStorage.removeItem('user');
                    showSuccessAlert('탈퇴되었습니다.');
                    setTimeout(() => {
                        window.location.href = "/";
                    }, 850);
                } else {
                    showErrorAlert('탈퇴 실패: ' + res.status);
                }
            } catch (err) {
                console.error('탈퇴 중 오류:', err);
                showErrorAlert('네트워크 오류가 발생했습니다.');
            }
        }
    </script>

    <!-- 스크립트 수정 - 내가 쓴 게시글 목록 템플릿 -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 기존 postList 함수 오버라이드
            window.postList = async function() {
                const userJson = sessionStorage.getItem("user");
                const user = userJson ? JSON.parse(userJson) : null;
                if (!user) {
                    console.error("로그인 정보가 없습니다.");
                    return;
                }

                const url = "/api/v1/myPage/posts"
                    + "?page=" + PAGE
                    + "&size=" + SIZE
                    + "&searchType=" + SEARCH_TYPE
                    + "&keyword=" + encodeURIComponent(user.userId);

                try {
                    const res = await fetch(url, {credentials: 'include'});
                    if (!res.ok) throw new Error(`게시글 조회 실패: ${res.status}`);
                    const data = await res.json();

                    const list = document.getElementById('postList');
                    list.innerHTML = '';

                    if (data.content.length === 0) {
                        list.innerHTML = `
                        <li class="list-group-item text-center py-5">
                            <i class="bi bi-file-earmark-x fs-1 text-muted mb-3"></i>
                            <p class="text-muted">작성한 게시글이 없습니다.</p>
                        </li>`;
                    } else {
                        data.content.forEach(post => {
                            list.innerHTML += `
                            <li class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="mb-1">
                                            <a href="/postDetail/${post.postId}" class="text-decoration-none">${post.title}</a>
                                        </h5>
                                        <small class="text-muted">
                                            <i class="bi bi-eye me-1"></i> ${post.viewCnt}
                                            <i class="bi bi-calendar3 ms-2 me-1"></i> ${formatDate(post.createdAt)}
                                        </small>
                                    </div>
                                    <a href="/postDetail/${post.postId}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-arrow-right"></i>
                                    </a>
                                </div>
                            </li>`;
                        }
                    }

                    makePaginationHTML(SIZE, data.totalPages, CURRENT_PAGE_INDEX,
                        data.totalElements, "paginationWrapper");
                } catch (err) {
                    console.error(err);
                }
            };

            // 기존 commentList 함수 오버라이드
            window.commentList = async function() {
                const userJson = sessionStorage.getItem("user");
                const user = userJson ? JSON.parse(userJson) : null;
                if (!user) {
                    console.error("로그인 정보가 없습니다.");
                    return;
                }

                const url = "/api/v1/myPage/comments"
                    + "?userId=" + encodeURIComponent(user.userId)
                    + "&page=" + PAGE
                    + "&size=" + SIZE;

                try {
                    const res = await fetch(url, {credentials: 'include'});
                    if (!res.ok) throw new Error(`댓글 조회 실패: ${res.status}`);
                    const data = await res.json();

                    const list = document.getElementById('commentList');
                    list.innerHTML = '';

                    if (data.content.length === 0) {
                        list.innerHTML = `
                        <li class="list-group-item text-center py-5">
                            <i class="bi bi-chat-square-x fs-1 text-muted mb-3"></i>
                            <p class="text-muted">작성한 댓글이 없습니다.</p>
                        </li>`;
                    } else {
                        data.content.forEach(c => {
                            list.innerHTML += `
                            <li class="list-group-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <p class="mb-1">${c.content}</p>
                                        <small class="text-muted">
                                            <a href="/postDetail/${c.postId}" class="text-decoration-none">
                                                <i class="bi bi-file-earmark-text me-1"></i> ${c.postTitle}
                                            </a>
                                            <i class="bi bi-calendar3 ms-2 me-1"></i> ${formatDate(c.createdAt)}
                                        </small>
                                    </div>
                                    <a href="/postDetail/${c.postId}" class="btn btn-sm btn-outline-primary ms-2">
                                        <i class="bi bi-arrow-right"></i>
                                    </a>
                                </div>
                            </li>`;
                        });
                    }

                    makePaginationHTML(SIZE, data.totalPages, CURRENT_PAGE_INDEX,
                        data.totalElements, "commentPagination");
                } catch (err) {
                    console.error(err);
                }
            };
        });
    </script>
</body>
</html>
