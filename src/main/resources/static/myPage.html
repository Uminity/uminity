<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Uminity - 마이페이지</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq"
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="icon" type="image/png" href="/assets/images/favicon.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <script src="/assets/js/util.js" defer></script>
    <script src="/assets/js/alert.js" defer></script>
    <style>
        #likes-tab {
        }
    </style>
</head>
<body>
    <!-- 네비게이션 -->
    <div id="nav-placeholder" class="pb-5"></div>

    <div class="container my-5">
        <div class="row">
            <!-- 사이드바 -->
            <aside class="col-md-3 mb-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title mb-3">마이페이지</h5>
                        <div class="list-group list-group-flush" id="myTab" role="tablist">
                            <a class="list-group-item list-group-item-action active" id="info-tab" data-bs-toggle="list"
                               href="#info" role="tab">
                                <i class="bi bi-person-gear me-2"></i> 회원정보 수정
                            </a>
                            <a class="list-group-item list-group-item-action" id="password-tab" data-bs-toggle="list"
                               href="#password" role="tab">
                                <i class="bi bi-key me-2"></i> 비밀번호 변경
                            </a>
                            <a class="list-group-item list-group-item-action" id="posts-tab" data-bs-toggle="list"
                               href="#posts" role="tab">
                                <i class="bi bi-file-earmark-text me-2"></i> 내가 쓴 글
                            </a>
                            <a class="list-group-item list-group-item-action" id="comments-tab" data-bs-toggle="list"
                               href="#comments" role="tab">
                                <i class="bi bi-chat-dots me-2"></i> 내가 쓴 댓글
                            </a>
                            <a class="list-group-item list-group-item-action" id="likes-tab" data-bs-toggle="list"
                               href="#likes" role="tab">
                                <i class="bi bi-heart me-2"></i> 좋아요 목록
                            </a>
                            <a class="list-group-item list-group-item-action text-danger" id="withdraw-tab"
                               data-bs-toggle="list" href="#withdraw" role="tab">
                                <i class="bi bi-person-x me-2"></i> 회원 탈퇴
                            </a>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- 콘텐츠 영역 -->
            <main class="col-md-9">
                <div class="tab-content" id="myTabContent">
                    <!-- 회원정보 수정 -->
                    <div class="tab-pane fade show active" id="info" role="tabpanel" aria-labelledby="info-tab">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h2 class="card-title mb-4"><i class="bi bi-person-gear me-2"></i> 회원정보 수정</h2>
                                <form id="updateForm">
                                    <div class="mb-3">
                                        <label for="name" class="form-label">이름</label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-light"><i class="bi bi-person"></i></span>
                                            <input type="text" class="form-control" id="name" placeholder="이름 입력">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="email" class="form-label">이메일</label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-light"><i class="bi bi-envelope"></i></span>
                                            <input type="email" class="form-control bg-light" id="email" readonly disabled>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="phone" class="form-label">휴대폰 번호</label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-light"><i class="bi bi-phone"></i></span>
                                            <input type="tel" class="form-control" id="phone" placeholder="010-1234-5678">
                                        </div>
                                    </div>
                                    <div class="mb-4">
                                        <label for="role" class="form-label">등급</label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-light"><i class="bi bi-award"></i></span>
                                            <input type="text" class="form-control bg-light" id="role" readonly disabled>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary"><i class="bi bi-check-lg me-1"></i> 저장하기
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- 비밀번호 변경 -->
                    <div class="tab-pane fade" id="password" role="tabpanel" aria-labelledby="password-tab">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h2 class="card-title mb-4"><i class="bi bi-key me-2"></i> 비밀번호 변경</h2>
                                <form id="passwordForm">
                                    <div class="mb-3">
                                        <label for="currentPassword" class="form-label">현재 비밀번호</label>
                                        <input type="password" class="form-control" id="currentPassword"
                                               placeholder="현재 비밀번호 입력" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="newPassword" class="form-label">새 비밀번호</label>
                                        <input type="password" class="form-control" id="newPassword" placeholder="새 비밀번호 입력"
                                               required>
                                    </div>
                                    <div class="mb-4">
                                        <label for="confirmPassword" class="form-label">비밀번호 확인</label>
                                        <input type="password" class="form-control" id="confirmPassword"
                                               placeholder="새 비밀번호 확인" required>
                                    </div>
                                    <button type="button" class="btn btn-primary" id="btnChangePassword"><i
                                            class="bi bi-check-lg me-1"></i> 변경하기
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- 내가 쓴 글 -->
                    <div class="tab-pane fade" id="posts" role="tabpanel" aria-labelledby="posts-tab">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h2 class="card-title mb-4"><i class="bi bi-file-earmark-text me-2"></i> 내가 쓴 게시글</h2>
                                <ul class="list-group" id="postList"></ul>
                                <nav class="mt-4">
                                    <ul class="pagination justify-content-center" id="paginationWrapper"></ul>
                                </nav>
                            </div>
                        </div>
                    </div>

                    <!-- 내가 쓴 댓글 -->
                    <div class="tab-pane fade" id="comments" role="tabpanel" aria-labelledby="comments-tab">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h2 class="card-title mb-4"><i class="bi bi-chat-dots me-2"></i> 내가 쓴 댓글</h2>
                                <ul class="list-group" id="commentList"></ul>
                                <nav class="mt-4">
                                    <ul class="pagination justify-content-center" id="commentPagination"></ul>
                                </nav>
                            </div>
                        </div>
                    </div>

                    <!-- 내가 좋아요 한 것 -->
                    <div class="tab-pane fade" id="likes" role="tabpanel" aria-labelledby="likes-tab">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h2 class="card-title mb-4"><i class="bi bi-chat-dots me-2"></i> 좋아요 목록</h2>
                                <ul class="list-group" id="LikeList"></ul>
                                <nav class="mt-4">
                                    <ul class="pagination justify-content-center" id="LikePagination"></ul>
                                </nav>
                            </div>
                        </div>
                    </div>

                    <!-- 회원 탈퇴 -->
                    <div class="tab-pane fade" id="withdraw" role="tabpanel" aria-labelledby="withdraw-tab">
                        <div class="card shadow-sm border-danger">
                            <div class="card-body">
                                <h2 class="card-title text-danger mb-4"><i class="bi bi-exclamation-triangle me-2"></i> 회원
                                    탈퇴</h2>
                                <div class="alert alert-warning"><i class="bi bi-info-circle me-2"></i> 탈퇴 시 모든 데이터가 삭제되며
                                    복구할 수 없습니다.
                                </div>
                                <p>탈퇴하시면 작성하신 게시글과 댓글은 남아있지만, 계정 정보는 삭제됩니다. 정말로 탈퇴하시겠습니까?</p>
                                <button type="button" class="btn btn-danger" id="btn-withdraw"><i
                                        class="bi bi-person-x me-2"></i> 탈퇴하기
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 스크립트 -->
    <script>
        window.onload = async function () {
            // 1) CSRF 초기화
            await initUtil();

            // 2) 네비 로드
            const navHtml = await fetch('/assets/nav.html').then(r => r.text());
            document.getElementById('nav-placeholder').innerHTML = navHtml;
            initUI();

            // 3) 내 정보 및 초기 콘텐츠 로드
            await loadMyInfo();
            postList();

            // 4) 이벤트 바인딩
            document.getElementById('updateForm').addEventListener('submit', async e => {
                e.preventDefault();
                const payload = {
                    name: document.getElementById('name').value.trim(),
                    phone: document.getElementById('phone').value.trim()
                };
                const res = await util.fetchWithCsrf('/api/v1/myPage', {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                if (res.status === 204) {
                    showSuccessAlert('회원정보가 정상적으로 수정되었습니다.');
                    await loadMyInfo();
                } else {
                    const err = await res.json();
                    showErrorAlert('수정 실패: ' + (err.message || res.status));
                }
            });

            document.getElementById('btnChangePassword').addEventListener('click', async () => {
                const current = document.getElementById('currentPassword').value;
                const next = document.getElementById('newPassword').value;
                const confirm = document.getElementById('confirmPassword').value;
                if (!current || !next || next !== confirm) return showErrorAlert('비밀번호가 일치하지 않거나 입력이 누락되었습니다.');
                const res = await util.fetchWithCsrf('/api/v1/myPage/password', {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({currentPassword: current, newPassword: next})
                });
                if (res.ok) {
                    showSuccessAlert('비밀번호가 변경되었습니다.');
                    setTimeout(() => window.location.href = '/myPage', 850);
                } else showErrorAlert('비밀번호 변경에 실패했습니다.');
            });

            document.getElementById('posts-tab').addEventListener('shown.bs.tab', () => {
                PAGE = 0;
                CURRENT_PAGE_INDEX = 1;
                postList();
            });
            document.getElementById('comments-tab').addEventListener('shown.bs.tab', () => {
                PAGE = 0;
                CURRENT_PAGE_INDEX = 1;
                commentList();
            });
            document.getElementById('likes-tab').addEventListener('shown.bs.tab', () => {
                PAGE = 0;
                CURRENT_PAGE_INDEX = 1;
                likeList();
            });

            document.getElementById('btn-withdraw').addEventListener('click', async () => {
                if (!await showConfirm('정말로 탈퇴하시겠습니까?', '회원 탈퇴', '탈퇴하기', '취소')) return;
                const r = await util.fetchWithCsrf('/api/v1/myPage', {method: 'DELETE'});
                if (r.ok) {
                    sessionStorage.removeItem('user');
                    showSuccessAlert('탈퇴되었습니다.');
                    setTimeout(() => location.href = '/', 850);
                } else showErrorAlert('탈퇴 실패: ' + r.status);
            });
        };

        async function loadMyInfo() {
            try {
                const res = await util.fetchWithCsrf('/api/v1/myPage', {method: 'GET'});
                if (!res.ok) throw res;
                const {name, email, phone, roles} = await res.json();
                document.getElementById('name').value = name;
                document.getElementById('email').value = email;
                document.getElementById('phone').value = phone;
                document.getElementById('role').value = roles.join(', ');
            } catch (err) {
                console.error('내 정보 로드 실패', err);
            }
        }

        let SIZE = 10, PAGE = 0, SEARCH_TYPE = 'USERID', CURRENT_PAGE_INDEX = 1;

        async function postList() {
            const userJson = sessionStorage.getItem('user');
            if (!userJson) return;
            const userId = JSON.parse(userJson).userId;
            const url = `/api/v1/myPage/posts?page=${PAGE}&size=${SIZE}&searchType=${SEARCH_TYPE}&keyword=${encodeURIComponent(userId)}`;
            try {
                const res = await util.fetchWithCsrf(url, {method: 'GET'});
                if (!res.ok) throw res;
                const data = await res.json();
                const list = document.getElementById('postList');
                list.innerHTML = '';
                if (data.content.length === 0) {
                    list.innerHTML = '<li class="list-group-item text-center py-5"><i class="bi bi-file-earmark-x fs-1 text-muted mb-3"></i><p class="text-muted">작성한 게시글이 없습니다.</p></li>';
                } else {
                    data.content.forEach(post => {
                        list.innerHTML += `<li class="list-group-item"><div class="d-flex justify-content-between align-items-center"><div><h5 class="mb-1"><a href="/postDetail/${post.postId}" class="text-decoration-none">${post.title}</a></h5><small class="text-muted"><i class="bi bi-eye me-1"></i>${post.viewCnt}<i class="bi bi-calendar3 ms-2 me-1"></i>${formatDate(post.createdAt)}</small></div><a href="/postDetail/${post.postId}" class="btn btn-sm btn-outline-primary ms-2"><i class="bi bi-arrow-right"></i></a></div></li>`;
                    });
                }
                makePaginationHTML(SIZE, data.totalPages, CURRENT_PAGE_INDEX, data.totalElements, 'paginationWrapper');
            } catch (e) {
                console.error('게시글 로드 실패', e);
            }
        }

        async function commentList() {
            const userJson = sessionStorage.getItem('user');
            if (!userJson) return;
            const userId = JSON.parse(userJson).userId;
            const url = `/api/v1/myPage/comments?userId=${encodeURIComponent(userId)}&page=${PAGE}&size=${SIZE}`;
            try {
                const res = await util.fetchWithCsrf(url, {method: 'GET'});
                if (!res.ok) throw res;
                const data = await res.json();
                const list = document.getElementById('commentList');
                list.innerHTML = '';
                if (data.content.length === 0) {
                    list.innerHTML = '<li class="list-group-item text-center py-5"><i class="bi bi-chat-square-x fs-1 text-muted mb-3"></i><p class="text-muted">작성한 댓글이 없습니다.</p></li>';
                } else {
                    data.content.forEach(c => {
                        list.innerHTML += `<li class="list-group-item"><div class="d-flex justify-content-between align-items-start"><div><p class="mb-1">${c.content}</p><small class="text-muted"><a href="/postDetail/${c.postId}" class="text-decoration-none"><i class="bi bi-file-earmark-text me-1"></i>${c.postTitle}</a><i class="bi bi-calendar3 ms-2 me-1"></i>${formatDate(c.createdAt)}</small></div><a href="/postDetail/${c.postId}" class="btn btn-sm btn-outline-primary ms-2"><i class="bi bi-arrow-right"></i></a></div></li>`;
                    });
                }
                makePaginationHTML(SIZE, data.totalPages, CURRENT_PAGE_INDEX, data.totalElements, 'LikePagination');
            } catch (e) {
                console.error('댓글 로드 실패', e);
            }
        }

        async function likeList() {
            const userJson = sessionStorage.getItem('user');
            if (!userJson) return;
            const userId = JSON.parse(userJson).userId;
            const url = `/api/v1/myPage/likes?userId=${encodeURIComponent(userId)}&page=${PAGE}&size=${SIZE}`;
            try {
                const res = await util.fetchWithCsrf(url, {method: 'GET'});
                if (!res.ok) throw res;
                const data = await res.json();
                const list = document.getElementById('LikeList');
                list.innerHTML = '';
                if (data.content.length === 0) {
                    list.innerHTML = '<li class="list-group-item text-center py-5"><i class="bi bi-heart fs-1 text-muted mb-3"></i><p class="text-muted">좋아요한 게시글이 없습니다.</p></li>';
                } else {
                    data.content.forEach(like => {
                        list.innerHTML += `<li class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <h5 class="mb-1">
                          <a href="/postDetail/${like.postId}" class="text-decoration-none">
                            ${like.title}
                          </a>
                        </h5>
                      </div>
                      <a href="/postDetail/${like.postId}" class="btn btn-sm btn-outline-primary ms-2">
                        <i class="bi bi-arrow-right"></i>
                      </a>
                    </div>
                  </li>`;
                    });
                }
                makePaginationHTML(SIZE, data.totalPages, CURRENT_PAGE_INDEX, data.totalElements, 'commentPagination');
            } catch (e) {
                console.error('댓글 로드 실패', e);
            }
        }
    </script>

    <!-- 스크립트 수정 - 내가 쓴 게시글 목록 템플릿 -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // 기존 postList 함수 오버라이드
            window.postList = async function () {
                const userJson = sessionStorage.getItem("user");
                const user = userJson ? JSON.parse(userJson) : null;
                if (!user) {
                    console.error("로그인 정보가 없습니다.");
                    return;
                }

                const url = "/api/v1/myPage/posts"
                    + "?page=" + PAGE
                    + "&size=" + SIZE
                    + "&searchType=" + SEARCH_TYPE
                    + "&keyword=" + encodeURIComponent(user.userId);

                try {
                    const res = await fetch(url, {credentials: 'include'});
                    if (!res.ok) throw new Error(`게시글 조회 실패: ${res.status}`);
                    const data = await res.json();

                    const list = document.getElementById('postList');
                    list.innerHTML = '';

                    if (data.content.length === 0) {
                        list.innerHTML = `
                        <li class="list-group-item text-center py-5">
                            <i class="bi bi-file-earmark-x fs-1 text-muted mb-3"></i>
                            <p class="text-muted">작성한 게시글이 없습니다.</p>
                        </li>`;
                    } else {
                        data.content.forEach(post => {
                            list.innerHTML += `
                            <li class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="mb-1">
                                            <a href="/postDetail/${post.postId}" class="text-decoration-none">${post.title}</a>
                                        </h5>
                                        <small class="text-muted">
                                            <i class="bi bi-eye me-1"></i> ${post.viewCnt}
                                            <i class="bi bi-calendar3 ms-2 me-1"></i> ${formatDate(post.createdAt)}
                                        </small>
                                    </div>
                                    <a href="/postDetail/${post.postId}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-arrow-right"></i>
                                    </a>
                                </div>
                            </li>`;
                        });
                    }

                    makePaginationHTML(SIZE, data.totalPages, CURRENT_PAGE_INDEX,
                        data.totalElements, "paginationWrapper");
                } catch (err) {
                    console.error(err);
                }
            };

            // 기존 commentList 함수 오버라이드
            window.commentList = async function () {
                const userJson = sessionStorage.getItem("user");
                const user = userJson ? JSON.parse(userJson) : null;
                if (!user) {
                    console.error("로그인 정보가 없습니다.");
                    return;
                }

                const url = "/api/v1/myPage/comments"
                    + "?userId=" + encodeURIComponent(user.userId)
                    + "&page=" + PAGE
                    + "&size=" + SIZE;

                try {
                    const res = await fetch(url, {credentials: 'include'});
                    if (!res.ok) throw new Error(`댓글 조회 실패: ${res.status}`);
                    const data = await res.json();

                    const list = document.getElementById('commentList');
                    list.innerHTML = '';

                    if (data.content.length === 0) {
                        list.innerHTML = `
                        <li class="list-group-item text-center py-5">
                            <i class="bi bi-chat-square-x fs-1 text-muted mb-3"></i>
                            <p class="text-muted">작성한 댓글이 없습니다.</p>
                        </li>`;
                    } else {
                        data.content.forEach(c => {
                            list.innerHTML += `
                            <li class="list-group-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <p class="mb-1">${c.content}</p>
                                        <small class="text-muted">
                                            <a href="/postDetail/${c.postId}" class="text-decoration-none">
                                                <i class="bi bi-file-earmark-text me-1"></i> ${c.postTitle}
                                            </a>
                                            <i class="bi bi-calendar3 ms-2 me-1"></i> ${formatDate(c.createdAt)}
                                        </small>
                                    </div>
                                    <a href="/postDetail/${c.postId}" class="btn btn-sm btn-outline-primary ms-2">
                                        <i class="bi bi-arrow-right"></i>
                                    </a>
                                </div>
                            </li>`;
                        });
                    }

                    makePaginationHTML(SIZE, data.totalPages, CURRENT_PAGE_INDEX,
                        data.totalElements, "commentPagination");
                } catch (err) {
                    console.error(err);
                }
            };
        });
    </script>
</body>
</html>