<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Uminity - 마이페이지</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq"
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="icon" type="image/png" href="/assets/images/favicon.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <script src="/assets/js/util.js" defer></script>
    <script src="/assets/js/alert.js" defer></script>
</head>
<body>
    <div id="nav-placeholder"></div>
    <div class="container my-5">
        <div class="row">
            <aside class="col-md-3 mb-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title mb-3">마이페이지</h5>
                        <div class="list-group list-group-flush" id="myTab" role="tablist">
                            <a class="list-group-item list-group-item-action active" id="info-tab" data-bs-toggle="list" href="#info" role="tab">
                                <i class="bi bi-person-gear me-2"></i> 회원정보 수정
                            </a>
                            <a class="list-group-item list-group-item-action" id="password-tab" data-bs-toggle="list" href="#password" role="tab">
                                <i class="bi bi-key me-2"></i> 비밀번호 변경
                            </a>
                            <a class="list-group-item list-group-item-action" id="posts-tab" data-bs-toggle="list" href="#posts" role="tab">
                                <i class="bi bi-file-earmark-text me-2"></i> 내가 쓴 글
                            </a>
                            <a class="list-group-item list-group-item-action" id="comments-tab" data-bs-toggle="list" href="#comments" role="tab">
                                <i class="bi bi-chat-dots me-2"></i> 내가 쓴 댓글
                            </a>
                            <a class="list-group-item list-group-item-action text-danger" id="withdraw-tab" data-bs-toggle="list" href="#withdraw" role="tab">
                                <i class="bi bi-person-x me-2"></i> 회원 탈퇴
                            </a>
                        </div>
                    </div>
                </div>
            </aside>
            <main class="col-md-9">
                <div class="tab-content" id="myTabContent">
                    <!-- 회원정보 수정 -->
                    <div class="tab-pane fade show active" id="info" role="tabpanel" aria-labelledby="info-tab">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h2 class="card-title mb-4"><i class="bi bi-person-gear me-2"></i> 회원정보 수정</h2>
                                <form id="updateForm">
                                    <div class="mb-3">
                                        <label for="name" class="form-label">이름</label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-light"><i class="bi bi-person"></i></span>
                                            <input type="text" class="form-control" id="name" placeholder="이름 입력">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="email" class="form-label">이메일</label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-light"><i class="bi bi-envelope"></i></span>
                                            <input type="email" class="form-control bg-light" id="email" readonly disabled>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="phone" class="form-label">휴대폰 번호</label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-light"><i class="bi bi-phone"></i></span>
                                            <input type="tel" class="form-control" id="phone" placeholder="010-1234-5678">
                                        </div>
                                    </div>
                                    <div class="mb-4">
                                        <label for="role" class="form-label">등급</label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-light"><i class="bi bi-award"></i></span>
                                            <input type="text" class="form-control bg-light" id="role" readonly disabled>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary"><i class="bi bi-check-lg me-1"></i> 저장하기</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <!-- 비밀번호 변경 -->
                    <div class="tab-pane fade" id="password" role="tabpanel" aria-labelledby="password-tab">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h2 class="card-title mb-4"><i class="bi bi-key me-2"></i> 비밀번호 변경</h2>
                                <form id="passwordForm">
                                    <div class="mb-3">
                                        <label for="currentPassword" class="form-label">현재 비밀번호</label>
                                        <input type="password" class="form-control" id="currentPassword" placeholder="현재 비밀번호 입력" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="newPassword" class="form-label">새 비밀번호</label>
                                        <input type="password" class="form-control" id="newPassword" placeholder="새 비밀번호 입력" required>
                                    </div>
                                    <div class="mb-4">
                                        <label for="confirmPassword" class="form-label">비밀번호 확인</label>
                                        <input type="password" class="form-control" id="confirmPassword" placeholder="새 비밀번호 확인" required>
                                    </div>
                                    <button type="button" class="btn btn-primary" id="btnChangePassword"><i class="bi bi-check-lg me-1"></i> 변경하기</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <!-- 내가 쓴 글 -->
                    <div class="tab-pane fade" id="posts" role="tabpanel" aria-labelledby="posts-tab">
                        <!-- 생략 -->
                    </div>
                    <!-- 내가 쓴 댓글 -->
                    <div class="tab-pane fade" id="comments" role="tabpanel" aria-labelledby="comments-tab">
                        <!-- 생략 -->
                    </div>
                    <!-- 회원 탈퇴 -->
                    <div class="tab-pane fade" id="withdraw" role="tabpanel" aria-labelledby="withdraw-tab">
                        <!-- 생략 -->
                    </div>
                </div>
            </main>
        </div>
    </div>
    <!-- 공통 스크립트 -->
    <script>
        window.onload = async function () {
            // CSRF 토큰 초기화
            await initUtil();

            // 네비 로드 및 UI 세팅
            fetch('/assets/nav.html')
                .then(res => res.text())
                .then(html => {
                    document.getElementById('nav-placeholder').innerHTML = html;
                    initUI();

                    document.getElementById('btnChangePassword').addEventListener('click', async () => {
                        const current = document.getElementById('currentPassword').value;
                        const next = document.getElementById('newPassword').value;
                        const confirm = document.getElementById('confirmPassword').value;
                        if (!current || !next || next !== confirm) return showErrorAlert('비밀번호가 일치하지 않거나 입력이 누락되었습니다.');
                        try {
                            const res = await util.fetchWithCsrf('/api/v1/myPage/password', {
                                method: 'PATCH',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({currentPassword: current, newPassword: next})
                            });
                            if (res.ok) {
                                showSuccessAlert('비밀번호가 변경되었습니다.');
                                setTimeout(() => window.location.href = '/myPage', 1000);
                            } else showErrorAlert('비밀번호 변경에 실패했습니다.');
                        } catch (err) {
                            console.error(err);
                            showErrorAlert('서버 오류가 발생했습니다.');
                        }
                    });

                    document.getElementById('linkLogout')
                        .addEventListener('click', async e => {
                            e.preventDefault();
                            try {
                                const r = await util.fetchWithCsrf('/logout', {method: 'POST'});
                                if (!r.ok) console.warn('서버 로그아웃 실패:', r.status);
                            } catch (err) {
                                console.error('서버 로그아웃 에러:', err);
                            }
                            sessionStorage.removeItem('user');
                            window.location.href = '/';
                        });

                    document.getElementById('linkMyPage')
                        .addEventListener('click', e => {
                            e.preventDefault();
                            location.href = '/myPage';
                        });
                })
                .catch(err => console.error('네비 로드 실패:', err));
        };
    </script>

    <!-- 마이페이지 데이터 로드 & 이벤트 -->
    <script>
        // 나의 정보 불러오기
        async function loadMyInfo() {
            try {
                const res = await fetch('/api/v1/myPage', {method: 'GET', credentials: 'include'});
                if (!res.ok) throw res;
                const {name, email, phone, roles} = await res.json();
                document.getElementById('name').value = name;
                document.getElementById('email').value = email;
                document.getElementById('phone').value = phone;
                document.getElementById('role').value = roles.join(', ');
            } catch (err) {
                console.error('내 정보 로드 실패', err);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadMyInfo();

            // 정보 수정
            document.getElementById('updateForm')
                .addEventListener('submit', async e => {
                    e.preventDefault();
                    const payload = {
                        name: document.getElementById('name').value.trim(),
                        phone: document.getElementById('phone').value.trim()
                    };
                    try {
                        const res = await util.fetchWithCsrf('/api/v1/myPage', {
                            method: 'PATCH',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(payload)
                        });
                        if (res.status === 204) {
                            showSuccessAlert('회원정보가 정상적으로 수정되었습니다.');
                            loadMyInfo();
                        } else {
                            const err = await res.json();
                            showErrorAlert('수정 실패 : ' + (err.message || res.status));
                        }
                    } catch (err) {
                        console.error('수정 중 오류', err);
                        showErrorAlert('네트워크 오류가 발생했습니다.');
                    }
                });

            // 내가 쓴 게시글 탭
            document.getElementById('posts-tab')
                .addEventListener('shown.bs.tab', () => {
                    PAGE = 0;
                    CURRENT_PAGE_INDEX = 1;
                    postList();
                });

            // 내가 쓴 댓글 탭
            document.getElementById('comments-tab')
                .addEventListener('shown.bs.tab', () => {
                    PAGE = 0;
                    CURRENT_PAGE_INDEX = 1;
                    commentList();
                });

            // 탈퇴
            document.getElementById('btn-withdraw')
                .addEventListener('click', async () => {
                    const ok = await showConfirm('정말로 탈퇴하시겠습니까?', '회원 탈퇴', '탈퇴하기', '취소');
                    if (!ok) return;
                    try {
                        const r = await util.fetchWithCsrf('/api/v1/myPage', {method: 'DELETE'});
                        if (r.ok) {
                            sessionStorage.removeItem('user');
                            showSuccessAlert('탈퇴되었습니다.');
                            setTimeout(() => window.location.href = '/', 850);
                        } else showErrorAlert('탈퇴 실패: ' + r.status);
                    } catch (err) {
                        console.error('탈퇴 중 오류:', err);
                        showErrorAlert('네트워크 오류가 발생했습니다.');
                    }
                });

            // 기본 탭: 내 게시글
            postList();
        });

        let SIZE = 10, PAGE = 0, SEARCH_TYPE = 'USERID', SEARCH_WORD = '';
        let CURRENT_PAGE_INDEX = 1;

        // 내가 쓴 게시글 목록
        async function postList() {
            const userJson = sessionStorage.getItem('user');
            if (!userJson) return;
            const userId = JSON.parse(userJson).userId;
            const url = `/api/v1/myPage/posts?page=${PAGE}&size=${SIZE}&searchType=${SEARCH_TYPE}&keyword=${encodeURIComponent(userId)}`;
            try {
                const res = await fetch(url, {credentials: 'include'});
                const data = await res.json();
                const list = document.getElementById('postList');
                list.innerHTML = '';
                if (data.content.length === 0) {
                    list.innerHTML = `<li class="list-group-item text-center py-5">
                        <i class="bi bi-file-earmark-x fs-1 text-muted mb-3"></i>
                        <p class="text-muted">작성한 게시글이 없습니다.</p>
                    </li>`;
                } else {
                    data.content.forEach(post => {
                        list.innerHTML += `
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-1">
                                        <a href="/postDetail/${post.postId}" class="text-decoration-none">${post.title}</a>
                                    </h5>
                                    <small class="text-muted">
                                        <i class="bi bi-eye me-1"></i> ${post.viewCnt}
                                        <i class="bi bi-calendar3 ms-2 me-1"></i> ${formatDate(post.createdAt)}
                                    </small>
                                </div>
                                <a href="/postDetail/${post.postId}" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-arrow-right"></i>
                                </a>
                            </div>
                        </li>`;
                    });
                }
                makePaginationHTML(SIZE, data.totalPages, CURRENT_PAGE_INDEX, data.totalElements, 'paginationWrapper');
            } catch (err) {
                console.error(err);
            }
        }

        // 내가 쓴 댓글 목록
        async function commentList() {
            const userJson = sessionStorage.getItem('user');
            if (!userJson) return;
            const userId = JSON.parse(userJson).userId;
            const url = `/api/v1/myPage/comments?userId=${encodeURIComponent(userId)}&page=${PAGE}&size=${SIZE}`;
            try {
                const res = await fetch(url, {credentials: 'include'});
                const data = await res.json();
                const list = document.getElementById('commentList');
                list.innerHTML = '';
                if (data.content.length === 0) {
                    list.innerHTML = `<li class="list-group-item text-center py-5">
                        <i class="bi bi-chat-square-x fs-1 text-muted mb-3"></i>
                        <p class="text-muted">작성한 댓글이 없습니다.</p>
                    </li>`;
                } else {
                    data.content.forEach(c => {
                        list.innerHTML += `
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <p class="mb-1">${c.content}</p>
                                    <small class="text-muted">
                                        <a href="/postDetail/${c.postId}" class="text-decoration-none">
                                            <i class="bi bi-file-earmark-text me-1"></i> ${c.postTitle}
                                        </a>
                                        <i class="bi bi-calendar3 ms-2 me-1"></i> ${formatDate(c.createdAt)}
                                    </small>
                                </div>
                                <a href="/postDetail/${c.postId}" class="btn btn-sm btn-outline-primary ms-2">
                                    <i class="bi bi-arrow-right"></i>
                                </a>
                            </div>
                        </li>`;
                    });
                }
                makePaginationHTML(SIZE, data.totalPages, CURRENT_PAGE_INDEX, data.totalElements, 'commentPagination');
            } catch (err) {
                console.error(err);
            }
        }
    </script>
</body>
</html>
