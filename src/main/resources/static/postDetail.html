<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq"
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="icon" type="image/png" href="/assets/images/favicon.png">
    <title>Uminity</title>
</head>

<body>

    <!-- navbar -->
    <div id="nav-placeholder" class="pb-5"></div>

	<!-- 게시글 상세 -->
    <div class="container mt-5" >
        <div class="card mb-4" id="postDetail">
            
        </div>

        <!-- 댓글 목록 -->
        <div class="mb-4">
            <h5>댓글 <span id="commentCount"></span></h5>
            <div class="input-group mb-3 p-2 rounded border">
                <textarea class="form-control p-3" id="commentInput" placeholder="댓글을 입력하세요." rows="3" style="resize: none;"></textarea>
                <button class="btn btn-primary" id="commentSubmit" style="width: 120px;">등록</button>
            </div>
            <div class="border rounded p-3 mb-3" id="commentDiv"></div>
        </div>
    </div>

    <!-- footer -->
    <footer class="bg-light text-center text-lg-start mt-5 border-top">
        <div class="container p-4">
            <p class="text-center mb-0 text-muted">
                © 2025 Uminity. All rights reserved.
            </p>
        </div>
    </footer>

	<script src="/assets/js/util.js"></script>
    <script>
	    window.onload = function(){
	    	loadNavbar();
	    	postDetail();
	    	listComments();
	    	
	    	document.querySelector('#commentSubmit').onclick = createComment;
	    }
	    
	    
	    
	    
	    let postId = window.location.pathname.split("/").pop();
	    let PAGE = 0; let SIZE = 100;
	    
	    async function postDetail(){
	    	let response = await fetch("/api/posts/" + postId);
	    	
	    	if(response.ok){
	    		let data = await response.json();
	        	
	        	makeDetailHtml(data);
	    	}else{
	    		console.error("HTTP Error:", response.status);
	    	}
	    }
	    
	    function makeDetailHtml(post){
	    	let postDate = formatDate(post.createdAt);
	    	let postDetailDiv = document.querySelector("#postDetail").innerHTML =
	    		`
	    		<div class="card-body">
	            <h2 class="card-title">${post.title}</h2>
	            <div class="row">
	        		<div class="col">
	        			<p class="text-muted mb-2">작성자: <strong>${post.authorName}</strong> | 작성일: <strong>${postDate}</strong></p>
	        		</div>
	        		<div class="col d-flex justify-content-end">
	        			<p class="text-muted mb-3">좋아요: <strong>0</strong> | 조회수: <strong>${post.viewCnt}</strong></p>
	        		</div>
	        	</div>
	            <p class="card-text">${post.content}</p>
	            <div class="d-flex justify-content-end">
	                <a href="/postForm/${post.postId}" class="btn btn-outline-primary me-2">수정</a>
	                <button class="btn btn-outline-danger" onclick="deletePost(${post.postId})">삭제</button>
	            </div>
	            <hr>
	            <button class="btn btn-primary mb-3">👍 좋아요</button>
	        </div>
	        `;
	    		
	    }
	    
	    
	    async function listComments(){
	    	let url = `/api/posts/${postId}/comments?page=${PAGE}&size=${SIZE}`;
	    	let response = await fetch(url);
	    	if(response.ok){
	    		let data = await response.json();
	    		PAGE = data.page, SIZE = data.size;
	    		total_elements = data.totalElements, total_pages = data.totalPages;
	    		let comments = data.content;
	    		document.querySelector("#commentCount").innerText = `(${total_elements})`;
	    		let commentDiv = document.querySelector("#commentDiv");
	    		commentDiv.innerHTML = ``;
	    		
	    		comments.forEach(comment => {
	    			let commentData = formatDate(comment.createdAt);
	    			let commentHtml = `
		    			<p><strong>${comment.userName}</strong> <small>${commentData}</small></p>
		                <p>${comment.content}</p>
		                <div class="d-flex justify-content-end">
		                    <button class="btn btn-outline-primary btn-sm me-2" id="btnUpdateComment">수정</button>
		                    <button class="btn btn-outline-danger btn-sm" id="btnDeleteComment">삭제</button>
		                </div>
		    			`;
	    			commentDiv.insertAdjacentHTML("afterbegin", commentHtml);

	    		});
	    	}else{
	    		console.error("HTTP Error:", response.status);
	    	}
	    }
	    
	    
	   
	    function deletePost(postId) {
	        if (!confirm("이 게시글을 삭제하시겠습니까?")) {
	            return;
	        }
	
	        fetch(`/api/posts/${Number(postId)}`, {
	            method: "DELETE"
	        })
	        .then(response => {
	            if (response.ok) {
	                alert("게시글이 성공적으로 삭제되었습니다.");
	                location.href = "/";
	            } else {
	                alert("게시글 삭제에 실패했습니다.");
	                console.error("HTTP Error:", response.status);
	            }
	        })
	        .catch(error => {
	            console.error("서버 오류:", error);
	            alert("서버 오류가 발생했습니다.");
	        });
	    }
	    
	    
	    async function createComment(){
	    	let content = document.querySelector("#commentInput").value.trim();
	    	let userId = JSON.parse(sessionStorage.getItem("user")).userId;
	    	
	    	let commentData = {postId, content, userId}
	    	
	    	if(!content){
	    		alert("댓글을 입력하세요");
	    		return;
	    	}
	    	
	    	let response = await fetch(`/api/posts/${postId}/comments`,{
	    		method : 'POST',
	    		headers: {
	    			'Content-Type': 'application/json',
	    		},
	    		body: JSON.stringify(commentData),
	    	});
	    	
	    	if (response.ok){
	    		let result = await response.json();
	    		document.querySelector("#commentInput").value = "";
	    		listComments();
	    		console.log(result);
	    	}else{
	    		console.error("HTTP Error:", response.status);
	    	}
	    	
	    }

    </script>
</body>

</html>