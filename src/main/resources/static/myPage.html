<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Uminity - 마이페이지</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq"
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="icon" type="image/png" href="/assets/images/favicon.png">
</head>
<body>

    <!-- navbar placeholder -->
    <div id="nav-placeholder"></div>

    <div class="container my-5">
        <div class="row">
            <aside class="col-md-3">
                <div class="list-group" id="myTab" role="tablist">
                    <a class="list-group-item list-group-item-action active" id="info-tab" data-bs-toggle="list" href="#info" role="tab">회원정보 수정</a>
                    <a class="list-group-item list-group-item-action" id="posts-tab" data-bs-toggle="list" href="#posts" role="tab">내가 쓴 글</a>
                    <a class="list-group-item list-group-item-action" id="comments-tab" data-bs-toggle="list" href="#comments" role="tab">내가 쓴 댓글</a>
                    <a class="list-group-item list-group-item-action" id="reports-tab" data-bs-toggle="list" href="#reports" role="tab">신고 내역</a>
                    <a class="list-group-item list-group-item-action" id="sanctions-tab" data-bs-toggle="list" href="#sanctions" role="tab">제재 내역</a>
                    <a class="list-group-item list-group-item-action text-danger" id="withdraw-tab" data-bs-toggle="list" href="#withdraw" role="tab">회원 탈퇴</a>
                </div>
            </aside>
            <main class="col-md-9">
                <div class="tab-content" id="myTabContent">
                    <div class="tab-pane fade show active" id="info" role="tabpanel" aria-labelledby="info-tab">
                        <!-- 회원정보 수정 폼 -->
                        <h2>회원정보 수정</h2>
                        <form id="updateForm">
                            <div class="mb-3">
                                <label for="name" class="form-label">이름</label>
                                <input type="text" class="form-control" id="name" placeholder="이름 입력">
                            </div>
                            <div class="mb-3">
                                <label for="email" class="form-label">이메일</label>
                                <input type="email" class="form-control bg-light" id="email" placeholder="example@domain.com" readonly disabled>
                            </div>
                            <div class="mb-3">
                                <label for="phone" class="form-label">휴대폰 번호</label>
                                <input type="tel" class="form-control" id="phone" placeholder="010-1234-5678">
                            </div>
                            <div class="mb-3">
                                <label for="role" class="form-label">등급</label>
                                <input type="text" class="form-control bg-light" id="role" placeholder="일반유저" readonly disabled>
                            </div>
                            <button type="submit" class="btn btn-primary">저장하기</button>
                        </form>
                    </div>

                    <div class="tab-pane fade" id="posts" role="tabpanel" aria-labelledby="posts-tab">
                        <h2>내가 쓴 글</h2>
                        <ul class="list-group">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <a href="#" class="flex-grow-1 text-decoration-none">게시글 제목 예시</a>
                                <small class="text-muted">2025-05-01</small>
                            </li>
                        </ul>
                    </div>

                    <div class="tab-pane fade" id="comments" role="tabpanel" aria-labelledby="comments-tab">
                        <h2>내가 쓴 댓글</h2>
                        <ul class="list-group">
                            <li class="list-group-item">
                                <p>댓글 내용 예시</p>
                                <small class="text-muted">게시글 제목 - 2025-05-02</small>
                            </li>
                        </ul>
                    </div>

                    <div class="tab-pane fade" id="reports" role="tabpanel" aria-labelledby="reports-tab">
                        <h2>신고 내역</h2>
                        <table class="table">
                            <thead>
                            <tr>
                                <th>대상</th>
                                <th>사유</th>
                                <th>날짜</th>
                                <th>상태</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td>게시글 제목 예시</td>
                                <td>스팸</td>
                                <td>2025-04-30</td>
                                <td>처리중</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="tab-pane fade" id="sanctions" role="tabpanel" aria-labelledby="sanctions-tab">
                        <h2>제재 내역</h2>
                        <ul class="list-group">
                            <li class="list-group-item">
                                <p>게시글 작성 제한<br><small class="text-muted">2025-05-05 ~ 2025-05-12</small></p>
                            </li>
                        </ul>
                    </div>

                    <div class="tab-pane fade" id="withdraw" role="tabpanel" aria-labelledby="withdraw-tab">
                        <h2 class="text-danger">회원 탈퇴</h2>
                        <p>탈퇴 시 모든 데이터가 삭제되며 복구할 수 없습니다.</p>
                        <button class="btn btn-danger" id="btn-withdraw">탈퇴하기</button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 공통 스크립트 (네비용 util.js 포함) -->
    <script src="/assets/js/util.js"></script>
    <script>
        window.onload = function () {
            // 1) 공통 네비 로드
            fetch('/assets/nav.html')
                .then(res => res.text())
                .then(html => {
                    document.getElementById('nav-placeholder').innerHTML = html;

                    // nav가 삽입된 뒤에만 initUI(), 로그아웃/마이페이지 이벤트 연결
                    initUI();
                    document.getElementById("linkLogout")
                        .addEventListener("click", logout);
                    document.getElementById("linkMyPage")
                        .addEventListener("click", function (e) {
                            e.preventDefault();
                            location.href = '/myPage';
                        });
                })
                .catch(err => console.error('네비 로드 실패:', err));
        };

        function initUI() {
            const userJson = sessionStorage.getItem("user");
            if (userJson) {
                const user = JSON.parse(userJson);
                document.querySelector("#navUser .nav-link").textContent = `${user.name}님`;
                showLoggedIn();
            } else showLoginOnly();
        }

        function showLoginOnly() {
            document.getElementById("navLogin").style.display = "";
            document.getElementById("navUser").style.display = "none";
            document.getElementById("navMyPage").style.display = "none";
            document.getElementById("navLogout").style.display = "none";
        }

        function showLoggedIn() {
            document.getElementById("navLogin").style.display = "none";
            document.getElementById("navUser").style.display = "";
            document.getElementById("navMyPage").style.display = "";
            document.getElementById("navLogout").style.display = "";
        }

        async function logout(e) {
            e.preventDefault();
            try {
                const res = await fetch("/logout", {method: "GET", credentials: "include"});
                if (!res.ok) console.warn("서버 로그아웃 실패:", res.status);
            } catch (err) {
                console.error("서버 로그아웃 에러:", err);
            }
            sessionStorage.removeItem("user");
            window.location.href = "/";
        }
    </script>

    <!-- 마이페이지 데이터 로드 & submit -->
    <script>
        async function loadMyInfo() {
            try {
                const res = await fetch('/api/v1/myPage', {
                    method: 'GET',
                    credentials: 'include'
                });
                if (!res.ok) throw res;
                const {name, email, phone, roles} = await res.json();
                document.getElementById('name').value = name;
                document.getElementById('email').value = email;
                document.getElementById('phone').value = phone;
                document.getElementById('role').value = roles.join(', ');
            } catch (err) {
                console.error('내 정보 로드 실패', err);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadMyInfo();

            const form = document.getElementById('updateForm');
            form.addEventListener('submit', async e => {
                e.preventDefault();

                const payload = {
                    name: document.getElementById('name').value.trim(),
                    phone: document.getElementById('phone').value.trim()
                };

                try {
                    const res = await fetch('/api/v1/myPage', {
                        method: 'PATCH',
                        credentials: 'include',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });

                    if (res.status === 204) {
                        alert('회원정보가 정상적으로 수정되었습니다.');
                        loadMyInfo();
                    } else {
                        const err = await res.json();
                        alert('수정 실패: ' + (err.message || res.status));
                    }
                } catch (err) {
                    console.error('수정 중 오류', err);
                    alert('네트워크 오류가 발생했습니다.');
                }
            });
        });
    </script>
</body>
</html>
