<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>Uminity 로그인</title>

    <!-- 기존 스타일 그대로 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7"
          crossorigin="anonymous">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="icon" type="image/png" href="assets/images/favicon.png">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- 기존 alert.js -->
    <script src="/assets/js/alert.js" defer></script>
    <!-- util.js: CSRF 토큰 받아서 util.fetchWithCsrf() 제공 -->
    <script src="/assets/js/util.js" defer></script>
</head>

<body>
    <div class="container d-flex justify-content-center align-items-center min-vh-100">
        <div class="card shadow rounded-4 p-4" style="max-width: 400px; width: 100%;">
            <div class="text-center mb-4">
                <h2 class="text-primary mb-2">로그인</h2>
                <p class="text-muted">Uminity에 오신 것을 환영합니다</p>
            </div>

            <!-- 디자인 변경 없이 기존 구조 유지 -->
            <div>
                <div class="mb-3">
                    <label for="email" class="form-label">이메일</label>
                    <div class="input-group">
            <span class="input-group-text bg-light border-end-0">
              <i class="bi bi-envelope"></i>
            </span>
                        <input type="email" class="form-control border-start-0" id="email" name="email"
                               placeholder="이메일을 입력하세요." required>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="password" class="form-label">암호</label>
                    <div class="input-group">
            <span class="input-group-text bg-light border-end-0">
              <i class="bi bi-lock"></i>
            </span>
                        <input type="password" class="form-control border-start-0" id="password"
                               name="password" placeholder="암호를 입력하세요." required>
                    </div>
                </div>
                <div class="d-grid mb-4">
                    <!-- JS가 처리하도록 버튼은 type="button" 그대로 유지 -->
                    <button type="button" class="btn btn-primary btn-lg rounded-pill" id="btnLogin">
                        로그인
                    </button>
                </div>
            </div>

            <div class="text-center">
                <p>첫 방문이신가요?
                    <a href="/register" class="text-decoration-none fw-bold">회원가입</a>
                </p>
                <a href="/" class="text-muted text-decoration-none">
                    <i class="bi bi-arrow-left"></i> 뒤로가기
                </a>
            </div>
        </div>
    </div>

    <script>
        // 페이지 로드 후 util.initUtil()이 CSRF 토큰을 가져다 놓습니다.
        window.addEventListener('load', () => {
            // 로그인 버튼 이벤트 바인딩
            document.getElementById('btnLogin').addEventListener('click', async () => {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const params = new URLSearchParams({email, password});

                try {
                    // CSRF 헤더 + 세션 쿠키가 자동 포함됩니다.
                    const res = await util.fetchWithCsrf('/login', {
                        method: 'POST',
                        body: params
                    });

                    if (res.ok) {
                        const data = await res.json();
                        sessionStorage.setItem('user', JSON.stringify(data));
                        showSuccessAlert('로그인에 성공했습니다.');
                        setTimeout(() => window.location.href = '/', 850);
                    } else {
                        const err = await res.json();
                        showErrorAlert(err.message);
                    }
                } catch (e) {
                    showErrorAlert('로그인 중 오류가 발생했습니다.');
                    console.error(e);
                }
            });
        });
    </script>
</body>
</html>
